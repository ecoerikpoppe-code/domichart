<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>domiChart from Open LCA</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Barlow:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #1A5D8D;
            --bg: #f4f4f9;
        }
        body {
            font-family: 'Barlow', sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1 { color: #000; margin-bottom: 10px; font-weight: 600; }
        p { color: #444; margin-bottom: 20px; }

        /* Drop Zone */
        #drop-zone {
            width: 80%;
            max-width: 800px;
            height: 150px;
            border: 3px dashed #666;
            border-radius: 10px;
            background-color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            cursor: pointer;
            transition: border-color 0.3s, background-color 0.3s;
            margin-bottom: 30px;
        }
        #drop-zone.dragover {
            border-color: var(--primary);
            background-color: #e6f0fa;
        }
        #drop-zone p { margin: 0; font-size: 1.1em; pointer-events: none; color: #000; }
        
        /* Main Container */
        #chart-container {
            width: 90%;
            max-width: 1000px; 
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: none; 
        }

        .chart-wrapper {
            position: relative;
            height: 500px;
            width: 100%;
            margin-bottom: 40px; /* Space between chart and table */
        }
        
        .controls {
            margin-bottom: 15px;
            display: flex;
            gap: 20px;
            font-size: 1em;
            color: #000;
        }
        
        /* Buttons */
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        button.action-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            font-family: 'Barlow', sans-serif;
            font-size: 0.9em;
        }
        button.action-btn.secondary {
            background-color: #555;
        }
        button.action-btn:hover { opacity: 0.9; }

        /* New Example Button Style */
        #example-btn {
            background-color: #00A9E0; /* A different, bright color */
            margin-left: 10px;
            margin-bottom: 15px;
        }
        #example-btn:hover {
            background-color: #0081B0;
        }

        .error { color: #d32f2f; margin-top: 10px; display: none; }

        /* --- TABLE STYLES --- */
        #data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
            margin-top: 20px;
        }
        #data-table th, #data-table td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: right;
            color: #000;
        }
        #data-table th:first-child, #data-table td:first-child {
            text-align: left;
            font-weight: 600;
        }
        #data-table th {
            background-color: #f8f9fa;
            position: sticky;
            top: 0;
            font-weight: 600;
        }
        #data-table tr:nth-child(even) {
            background-color: #fcfcfc;
        }
        #data-table tr:hover {
            background-color: #f0f4f8;
        }
        .table-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 10px;
            color: #000;
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
        }
        
        /* Container for the new template download links */
        #download-links-area {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            text-align: center;
        }
        .template-btn {
            background-color: #2e7d32; /* Green for Excel */
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            margin: 0 10px;
            border-radius: 5px;
            font-weight: 600;
            display: inline-block;
            transition: background-color 0.2s;
        }
        .template-btn:hover {
            background-color: #1b5e20;
        }
    </style>
</head>
<body>

    <h1>domiChart - Dominance Analysis Charts from Open LCA</h1>
    <p>Drop your OpenLCA Excel export below to generate the chart and data table.</p>

    <div id="drop-zone">
        <p>Drag & Drop Excel file here</p>
        <p style="font-size: 0.8em; color: #555;">(or click to browse)</p>
        <input type="file" id="file-input" style="display: none;" accept=".xlsx, .xls">
    </div>

    <button class="action-btn" id="example-btn" onclick="loadExampleData()">Load Example Data</button>
    <div id="error-msg" class="error"></div>

    <div id="chart-container">
        <div class="controls">
            <label>
                <input type="checkbox" id="split-a-check"> Use split A modules [if available] in source file (A1, A2, A3)
            </label>
        </div>
        
        <div class="chart-wrapper">
            <canvas id="myChart"></canvas>
        </div>

        <div class="table-title">Detailed Contributions [%]</div>
        <div style="overflow-x: auto;">
            <table id="data-table">
            </table>
        </div>
        
        <div class="btn-group">
            <button class="action-btn" onclick="downloadChart()">Download Chart Image</button>
            <button class="action-btn secondary" onclick="copyTable()">Copy Table to Clipboard</button>
        </div>

        <div id="download-links-area"></div>
    </div>

    <script>
        // --- Configuration ---
        Chart.defaults.color = '#000000';
        Chart.defaults.font.family = "'Barlow', sans-serif";
        Chart.defaults.font.weight = '500';

        const impactCategories = [
            "GWP-t", "ODP", "AP", "EP-fw", "EP-m",
            "EP-t", "POCP", "ADPf", "ADPe", "WDP", "PERT", "PENRT", 
        ];

        const mapping = {
            "GWP-t": "Global Warming Potential - total",
            "ODP": "Depletion potential of the stratospheric ozone layer (ODP)",
            "AP": "Acidification potential",
            "EP-fw": "Eutrophication potential - freshwater",
            "EP-m": "Eutrophication potential - marine",
            "EP-t": "Eutrophication potential - terrestrial",
            "POCP": "Photochemical Ozone Creation Potential",
            "ADPf": "Abiotic depletion potential - fossil",
            "ADPe": "Abiotic depletion potential - non-fossil resources",
            "WDP": "Water (user) deprivation potential",
            "PERT": "Total use of renewable primary energy resources",
            "PENRT": "Total use of non renewable primary energy resources",
        };

        // Updated High Contrast / Mixed Palette
        const moduleColorMap = {
            "A1":    "#2962FF",  // Option 1 Blue
            "A1-A3": "#2962FF",  // Option 1 Blue
            "A2":    "#FFD600",  // Bright Yellow
            "A3":    "#D50000",  // Deep Red
            "A4":    "#FFAB00",  // Amber
            "A5":    "#00C853",  // Vivid Green
            "C1":    "#6200EA",  // Deep Violet
            "C2":    "#FFC400",  // Gold
            "C3":    "#FF1744",  // Bright Red / Pinkish
            "C4":    "#3E2723",  // Dark Brown
            "D":     "#8FAFBC"   // Neutral
        };
        
        // --- Template Configuration for Excel Export ---
        const templateColumnsDE = ["Indikator", "Exponential", "A1-A3", "A1", "A2", "A3", "A4", "A5", "B1", "B1/1", "B1/2", "B1/3", "B2", "B2/1", "B2/2", "B2/3", "B3", "B3/1", "B3/2", "B3/3", "B4", "B4/1", "B4/2", "B4/3", "B5", "B5/1", "B5/2", "B5/3", "B6", "B6/1", "B6/2", "B6/3", "B7", "B7/1", "B7/2", "B7/3", "C1", "C2", "C2/1", "C2/2", "C2/3", "C3", "C3/1", "C3/2", "C3/3", "C4", "C4/1", "C4/2", "C4/3", "D", "D/1", "D/2", "D/3"];
        const templateColumnsEN = ["Indicator", "Exponential", "A1-A3", "A1", "A2", "A3", "A4", "A5", "B1", "B1/1", "B1/2", "B1/3", "B2", "B2/1", "B2/2", "B2/3", "B3", "B3/1", "B3/2", "B3/3", "B4", "B4/1", "B4/2", "B4/3", "B5", "B5/1", "B5/2", "B5/3", "B6", "B6/1", "B6/2", "B6/3", "B7", "B7/1", "B7/2", "B7/3", "C1", "C2", "C2/1", "C2/2", "C2/3", "C3", "C3/1", "C3/2", "C3/3", "C4", "C4/1", "C4/2", "C4/3", "D", "D/1", "D/2", "D/3"];

        const deRows = [
            { name: "Globales Erwärmungspotenzial total (GWP-total)", code: "GWP-total" },
            { name: "Globales Erwärmungspotenzial fossil (GWP-fossil)", code: "GWP-fossil" },
            { name: "Globales Erwärmungspotenzial biogen (GWP-biogenic)", code: "GWP-biogenic" },
            { name: "Globales Erwärmungspotenzial luluc (GWP-luluc)", code: "GWP-luluc" },
            { name: "Abbau Potential der stratosphärischen Ozonschicht (ODP)", code: "ODP" },
            { name: "Versauerungspotenzial von Boden und Wasser (AP)", code: "AP" },
            { name: "Eutrophierungspotenzial Süßwasser (EP-freshwater)", code: "EP-freshwater" },
            { name: "Eutrophierungspotenzial Salzwasser (EP-marine)", code: "EP-marine" },
            { name: "Eutrophierungspotenzial Land (EP-terrestrial)", code: "EP-terrestrial" },
            { name: "Bildungspotential für troposphärisches Ozon (POCP)", code: "POCP" },
            { name: "Potenzial für den abiotischen Abbau nicht fossiler Ressourcen (ADPE)", code: "ADPE" },
            { name: "Potenzial für den abiotischen Abbau fossiler Brennstoffe (ADPF)", code: "ADPF" },
            { name: "Wassernutzung (WDP)", code: "WDP" },
            { name: "Erneuerbare Primärenergie als Energieträger (PERE)", code: "PERE" },
            { name: "Erneuerbare Primärenergie zur stofflichen Nutzung (PERM)", code: "PERM" },
            { name: "Total erneuerbare Primärenergie (PERT)", code: "PERT" },
            { name: "Nicht-erneuerbare Primärenergie als Energieträger (PENRE)", code: "PENRE" },
            { name: "Nicht-erneuerbare Primärenergie zur stofflichen Nutzung (PENRM)", code: "PENRM" },
            { name: "Total nicht erneuerbare Primärenergie (PENRT)", code: "PENRT" },
            { name: "Einsatz von Sekundärstoffen (SM)", code: "SM" },
            { name: "Erneuerbare Sekundärbrennstoffe (RSF)", code: "RSF" },
            { name: "Nicht erneuerbare Sekundärbrennstoffe (NRSF)", code: "NRSF" },
            { name: "Einsatz von Süßwasserressourcen (FW)", code: "FW" },
            { name: "Gefährlicher Abfall zur Deponie (HWD)", code: "HWD" },
            { name: "Entsorgter nicht gefährlicher Abfall (NHWD)", code: "NHWD" },
            { name: "Entsorgter radioaktiver Abfall (RWD)", code: "RWD" },
            { name: "Komponenten für die Wiederverwendung (CRU)", code: "CRU" },
            { name: "Stoffe zum Recycling (MFR)", code: "MFR" },
            { name: "Stoffe für die Energierückgewinnung (MER)", code: "MER" },
            { name: "Exportierte elektrische Energie (EEE)", code: "EEE" },
            { name: "Exportierte thermische Energie (EET)", code: "EET" },
            { name: "Auftreten von Krankheiten aufgrund von Feinstaubemissionen (PM)", code: "PM" },
            { name: "Wirkung durch Exposition des Menschen mit U235 (IR)", code: "IR" },
            { name: "Toxizitätsvergleichseinheit für Ökosysteme (ETP-fw)", code: "ETP-fw" },
            { name: "Toxizitätsvergleichseinheit für Menschen (krebserregend) (HTP-c)", code: "HTP-c" },
            { name: "Toxizitätsvergleichseinheit für Menschen (nicht krebserregend) (HTP-nc)", code: "HTP-nc" },
            { name: "Bodenqualitätsindex (SQP)", code: "SQP" }
        ];

        const enRows = [
            { name: "Global Warming Potential total (GWP-total)", code: "GWP-total" },
            { name: "Global Warming Potential fossil fuels (GWP-fossil)", code: "GWP-fossil" },
            { name: "Global Warming Potential biogenic (GWP-biogenic)", code: "GWP-biogenic" },
            { name: "Global Warming Potential luluc (GWP-luluc)", code: "GWP-luluc" },
            { name: "Depletion potential of the stratospheric ozone layer (ODP)", code: "ODP" },
            { name: "Acidification potential of land and water (AP)", code: "AP" },
            { name: "Eutrophication potential aquatic freshwater (EP-freshwater)", code: "EP-freshwater" },
            { name: "Eutrophication potential aquatic marine (EP-marine)", code: "EP-marine" },
            { name: "Eutrophication potential terrestrial (EP-terrestrial)", code: "EP-terrestrial" },
            { name: "Formation potential of tropospheric ozone photochemical oxidants (POCP)", code: "POCP" },
            { name: "Abiotic depletion potential for non fossil resources (ADPE)", code: "ADPE" },
            { name: "Abiotic depletion potential for fossil resources (ADPF)", code: "ADPF" },
            { name: "Water use (WDP)", code: "WDP" },
            { name: "Renewable primary energy as energy carrier (PERE)", code: "PERE" },
            { name: "Renewable primary energy resources as material utilization (PERM)", code: "PERM" },
            { name: "Total use of renewable primary energy resources (PERT)", code: "PERT" },
            { name: "Non renewable primary energy as energy carrier (PENRE)", code: "PENRE" },
            { name: "Non renewable primary energy as material utilization (PENRM)", code: "PENRM" },
            { name: "Total use of non renewable primary energy resources (PENRT)", code: "PENRT" },
            { name: "Use of secondary material (SM)", code: "SM" },
            { name: "Use of renewable secondary fuels (RSF)", code: "RSF" },
            { name: "Use of non renewable secondary fuels (NRSF)", code: "NRSF" },
            { name: "Use of net fresh water (FW)", code: "FW" },
            { name: "Hazardous waste disposed (HWD)", code: "HWD" },
            { name: "Non hazardous waste disposed (NHWD)", code: "NHWD" },
            { name: "Radioactive waste disposed (RWD)", code: "RWD" },
            { name: "Components for re-use (CRU)", code: "CRU" },
            { name: "Materials for recycling (MFR)", code: "MFR" },
            { name: "Materials for energy recovery (MER)", code: "MER" },
            { name: "Exported electrical energy (EEE)", code: "EEE" },
            { name: "Exported thermal energy (EET)", code: "EET" },
            { name: "Incidence of disease due to PM emissions (PM)", code: "PM" },
            { name: "Human exposure efficiency relative to U235 (IR)", code: "IR" },
            { name: "Comparative toxic unit for ecosystems (ETP-fw)", code: "ETP-fw" },
            { name: "Comparative toxic unit for humans (carcinogenic) (HTP-c)", code: "HTP-c" },
            { name: "Comparative toxic unit for humans (noncarcinogenic) (HTP-nc)", code: "HTP-nc" },
            { name: "Soil quality index (SQP)", code: "SQP" }
        ];

        let currentWorkbook = null;
        let chartInstance = null;
        // --- End Configuration ---

        // --- Event Listeners ---
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const errorMsg = document.getElementById('error-msg');
        const splitACheck = document.getElementById('split-a-check');

        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => { if (e.target.files.length) handleFile(e.target.files[0]); });
        splitACheck.addEventListener('change', () => { if (currentWorkbook) processDataAndRender(currentWorkbook); });

        // --- Core Functions ---
        
        function handleFile(file) {
            errorMsg.style.display = 'none';
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                try {
                    const workbook = XLSX.read(data, {type: 'array'});
                    handleWorkbook(workbook);
                } catch (err) {
                    showError("Could not parse Excel file. Ensure it is a valid OpenLCA export.");
                }
            };
            reader.readAsArrayBuffer(file);
        }

        async function loadExampleData() {
            errorMsg.style.display = 'none';
            const fileName = "example_data_results.xlsx";
            try {
                const response = await fetch(fileName);
                if (!response.ok) {
                    throw new Error(`Failed to fetch ${fileName}: ${response.statusText}`);
                }
                const arrayBuffer = await response.arrayBuffer();
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, {type: 'array'});
                handleWorkbook(workbook);
                alert('Example data loaded successfully!');

            } catch (err) {
                console.error(err);
                showError(`Error loading example data: ${err.message}. Make sure '${fileName}' is in the same directory.`);
            }
        }
        
        function handleWorkbook(workbook) {
            currentWorkbook = workbook;
            processDataAndRender(currentWorkbook);
        }

        function processDataAndRender(workbook) {
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});

            if (jsonData.length < 2) { showError("File is empty or invalid."); return; }

            // --- Existing Chart Logic ---
            const headerRow = jsonData[0]; 
            const useSplitA = splitACheck.checked;
            
            const moduleCandidates = useSplitA 
                ? ["A1", "A2", "A3", "A4", "A5", "C1", "C2", "C3", "C4", "D"]
                : ["A1-A3", "A4", "A5", "C1", "C2", "C3", "C4", "D"];

            const modules = moduleCandidates.filter(m => headerRow.includes(m));

            if (modules.length === 0) { showError("No valid module columns found."); return; }

            const chartData = { labels: [], datasets: {} };
            modules.forEach(m => chartData.datasets[m] = []);

            const tableDataRows = [];

            const colIndices = {};
            headerRow.forEach((col, index) => { if (typeof col === 'string') colIndices[col] = index; });
            const impactCatIndex = colIndices["Impact category"];

            if (impactCatIndex === undefined) { showError("Column 'Impact category' not found."); return; }

            impactCategories.forEach(shortCode => {
                const searchPattern = mapping[shortCode];
                if (!searchPattern) return;

                const row = jsonData.find(r => r[impactCatIndex] && r[impactCatIndex].toString().includes(searchPattern));
                if (!row) return;

                let sumRest = 0;
                const rowValues = {};

                modules.forEach(m => {
                    const idx = colIndices[m];
                    const val = (idx !== undefined && row[idx] != null) ? parseFloat(row[idx]) : 0;
                    rowValues[m] = val;
                    if (m !== 'D') sumRest += val;
                });

                if (sumRest === 0) sumRest = 1;

                chartData.labels.push(shortCode);
                const tableRow = { category: shortCode, values: {} };

                modules.forEach(m => {
                    const isSumModule = m !== 'D';
                    const valueForNormalization = isSumModule ? rowValues[m] : 0; 
                    const pct = (valueForNormalization / sumRest) * 100;
                    
                    chartData.datasets[m].push(pct);
                    tableRow.values[m] = pct;
                });

                if (modules.includes('D')) {
                    const idx = colIndices['D'];
                    const val = (idx !== undefined && row[idx] != null) ? parseFloat(row[idx]) : 0;
                    const pctD = (val / sumRest) * 100;
                    chartData.datasets['D'][chartData.datasets['D'].length - 1] = pctD;
                    tableRow.values['D'] = pctD;
                }
                
                tableDataRows.push(tableRow);
            });

            if (chartData.labels.length === 0) { showError("No matching impact categories found."); return; }

            renderChart(chartData.labels, chartData.datasets, modules);
            renderTable(tableDataRows, modules);

            // --- TRIGGER TEMPLATE GENERATION ---
            createAndDownloadTemplates(jsonData);
        }

        // --- Excel Template Generation Logic ---

        function getCode(text) {
            if (!text) return null;
            // Match content inside the last parenthesis
            const matches = text.toString().match(/\(([^)]+)\)/g);
            if (matches && matches.length > 0) {
                const last = matches[matches.length - 1];
                return last.replace('(', '').replace(')', '');
            }
            return null;
        }

        function createAndDownloadTemplates(sourceData) {
            if (!sourceData || sourceData.length < 2) return;

            const sourceHeaders = sourceData[0];
            const dataMap = {}; 

            // Map source data by code (e.g., "GWP-total" -> Row Data)
            for (let i = 1; i < sourceData.length; i++) {
                const row = sourceData[i];
                const name = row[0] ? row[0].toString() : null; 
                if (!name) continue;

                let code = getCode(name);
                
                // --- FIX for 'IRP' -> 'IR' mismatch in OpenLCA output ---
                if (code === "IRP" && name.includes("Human exposure efficiency relative to U235")) {
                    code = "IR"; // Force the correct code for template lookup
                }
                // --------------------------------------------------------

                if (code) {
                    dataMap[code] = row;
                }
            }

            // Helper to retrieve value from source based on column name
            function getValue(code, targetColName) {
                const sourceRow = dataMap[code];
                if (!sourceRow) return "";
                
                // Note: The source file might have "A1-A3" but not "A1".
                // We attempt to find the exact column name in source.
                const colIndex = sourceHeaders.indexOf(targetColName);
                if (colIndex !== -1) {
                    return sourceRow[colIndex];
                }
                return "";
            }

            // Build the data array for the Excel sheet
            function buildSheetData(rowDefinitions, headerColumns) {
                const sheetData = [headerColumns]; // Header Row
                
                rowDefinitions.forEach(rowDef => {
                    const newRow = [];
                    // 1. Indicator Name
                    newRow.push(rowDef.name);
                    // 2. Exponential (Fixed Value "x")
                    newRow.push("x"); 
                    
                    // 3. Map remaining columns
                    for (let j = 2; j < headerColumns.length; j++) {
                        const colName = headerColumns[j];
                        newRow.push(getValue(rowDef.code, colName));
                    }
                    sheetData.push(newRow);
                });
                return sheetData;
            }

            const deData = buildSheetData(deRows, templateColumnsDE);
            const enData = buildSheetData(enRows, templateColumnsEN);

            // Clear previous links
            const container = document.getElementById('download-links-area');
            container.innerHTML = "<h4>Download IBU Upload Templates</h4>";

            // Generate Links
            createDownloadLink(deData, "LCA_Ergebnisse_DE.xls", "Download IBU DE (Excel)", container);
            createDownloadLink(enData, "LCA_Results_EN.xls", "Download IBU EN (Excel)", container);
        }

        function createDownloadLink(aoaData, fileName, linkText, container) {
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(aoaData);
            XLSX.utils.book_append_sheet(wb, ws, "Results");

            // Write to binary
            const wbout = XLSX.write(wb, {bookType:'xls', type:'binary'});

            function s2ab(s) {
                const buf = new ArrayBuffer(s.length);
                const view = new Uint8Array(buf);
                for (let i=0; i<s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
                return buf;
            }

            const blob = new Blob([s2ab(wbout)], {type: "application/octet-stream"});
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.innerText = linkText;
            a.className = "template-btn";
            
            container.appendChild(a);
        }

        // --- Chart & Table Rendering Helpers ---

        function renderChart(labels, datasetsObj, moduleOrder) {
            const ctx = document.getElementById('myChart').getContext('2d');
            document.getElementById('chart-container').style.display = 'block';

            if (chartInstance) chartInstance.destroy();

            const chartDatasets = moduleOrder.map(mod => {
                const isD = mod === 'D';
                return {
                    label: mod,
                    data: datasetsObj[mod],
                    backgroundColor: moduleColorMap[mod] || "#999999",
                    stack: isD ? 'Stack_D' : 'Stack_Main', 
                    barPercentage: 0.95, 
                    categoryPercentage: 0.65
                };
            });

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels: labels, datasets: chartDatasets },
                options: {
                    devicePixelRatio: 4,
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Relative impact contributions per module (incl. D)',
                            font: { size: 18, family: "'Barlow', sans-serif", weight: '600' },
                            color: '#000000',
                            padding: { bottom: 20 }
                        },
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#000000',
                                font: { family: "'Barlow', sans-serif", size: 12 },
                                boxWidth: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            stacked: true, max: 100, 
                            title: { display: true, text: 'Contribution [%]', font: { weight: '600', size: 14 }, color: '#000000' },
                            ticks: { color: '#000000', font: { size: 12 } },
                            grid: { borderDash: [4, 4], color: '#e0e0e0' }
                        },
                        x: {
                            stacked: true,
                            title: { display: true, text: 'Impact Categories', font: { weight: '600', size: 14 }, color: '#000000' },
                            ticks: { color: '#000000', font: { size: 12, weight: '500' } }
                        }
                    }
                }
            });
        }

        function renderTable(dataRows, modules) {
            const table = document.getElementById('data-table');
            table.innerHTML = ""; 

            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            const thCat = document.createElement('th');
            thCat.innerText = "Impact Category";
            headerRow.appendChild(thCat);

            modules.forEach(mod => {
                const th = document.createElement('th');
                th.innerText = mod;
                th.style.borderBottom = `3px solid ${moduleColorMap[mod] || '#999'}`;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            dataRows.forEach(row => {
                const tr = document.createElement('tr');
                const tdCat = document.createElement('td');
                tdCat.innerText = row.category;
                tr.appendChild(tdCat);

                modules.forEach(mod => {
                    const td = document.createElement('td');
                    const val = row.values[mod];
                    td.innerText = val.toFixed(2);
                    if (val === 0) td.style.color = "#ccc";
                    tr.appendChild(td);
                });

                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
        }

        function showError(msg) {
            errorMsg.innerText = msg;
            errorMsg.style.display = 'block';
            document.getElementById('chart-container').style.display = 'none';
        }

        function downloadChart() {
            const link = document.createElement('a');
            link.download = 'LCA_Dominance_Chart.png';
            link.href = document.getElementById('myChart').toDataURL('image/png', 1.0);
            link.click();
        }

        function copyTable() {
            const table = document.getElementById('data-table');
            let range, selection;

            if (document.createRange && window.getSelection) {
                range = document.createRange();
                selection = window.getSelection();
                selection.removeAllRanges();
                try {
                    range.selectNodeContents(table);
                    selection.addRange(range);
                } catch (e) {
                    range.selectNode(table);
                    selection.addRange(range);
                }
                document.execCommand('copy');
                selection.removeAllRanges();
                alert('Table copied to clipboard!');
            }
        }
    </script>
</body>
</html>